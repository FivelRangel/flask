<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Restaurante</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        function App() {
            const [clientesPedidos, setClientesPedidos] = React.useState([]);
            const [ventasTotales, setVentasTotales] = React.useState(0);
            const [clienteSeleccionado, setClienteSeleccionado] = React.useState(null);
            const [formDetalles, setFormDetalles] = React.useState({
                nombre: '',
                telefono: '',
                direccion: '',
                pedidos: []
            });

            React.useEffect(() => {
                fetchPedidos();
                fetchVentasTotales();
            }, []);

            const fetchPedidos = async () => {
                const response = await fetch('/api/pedidos');
                const data = await response.json();
                setClientesPedidos(data);
            };

            const fetchVentasTotales = async () => {
                const response = await fetch('/api/ventas');
                const data = await response.json();
                setVentasTotales(data.ventasTotales);
            };

            const handleClienteClick = async (id) => {
                const response = await fetch(`/api/clientes/${id}`);
                if (response.ok) {
                    const data = await response.json();
                    setClienteSeleccionado(data);
                    setFormDetalles({
                        nombre: data.cliente.nombre,
                        telefono: data.cliente.telefono,
                        direccion: data.cliente.direccion,
                        pedidos: data.pedidos.map(pedido => ({
                            id: pedido.id,
                            menu: pedido.menu,
                            cantidad_personas: pedido.cantidad_personas,
                            total: pedido.total,
                            anticipo: pedido.anticipo,
                            restante: pedido.restante,
                            hora_entrega: pedido.hora_entrega,
                            estado: pedido.estado
                        }))
                    });
                }
            };

            const handleDetalleChange = (field, value) => {
                setFormDetalles(prevState => ({
                    ...prevState,
                    [field]: value
                }));
            };

            const handlePedidoChange = (index, field, value) => {
                const updatedPedidos = [...formDetalles.pedidos];
                updatedPedidos[index][field] = value;
                setFormDetalles(prevState => ({
                    ...prevState,
                    pedidos: updatedPedidos
                }));
            };

            const handleActualizar = async () => {
                const response = await fetch(`/api/clientes/${clienteSeleccionado.cliente.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formDetalles)
                });
                if (response.ok) {
                    alert('Detalles actualizados correctamente');
                    fetchPedidos();
                } else {
                    alert('Error al actualizar los detalles');
                }
            };

            const ClienteDetalle = () => {
                if (!clienteSeleccionado) return null;

                return (
                    <div className="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                        <h2 className="text-2xl font-bold mb-4">Detalles del Cliente</h2>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-2">Nombre:</label>
                                <input
                                    className="shadow border rounded w-full py-2 px-3"
                                    value={formDetalles.nombre}
                                    onChange={(e) => handleDetalleChange('nombre', e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-2">Teléfono:</label>
                                <input
                                    className="shadow border rounded w-full py-2 px-3"
                                    value={formDetalles.telefono}
                                    onChange={(e) => handleDetalleChange('telefono', e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-gray-700 text-sm font-bold mb-2">Dirección:</label>
                                <input
                                    className="shadow border rounded w-full py-2 px-3"
                                    value={formDetalles.direccion}
                                    onChange={(e) => handleDetalleChange('direccion', e.target.value)}
                                />
                            </div>
                            <h3 className="text-xl font-semibold mt-4">Pedidos:</h3>
                            {formDetalles.pedidos.map((pedido, index) => (
                                <div key={index} className="space-y-2">
                                    <div>
                                        <label className="block text-gray-700 text-sm font-bold mb-2">Menú:</label>
                                        <input
                                            className="shadow border rounded w-full py-2 px-3"
                                            value={pedido.menu}
                                            onChange={(e) => handlePedidoChange(index, 'menu', e.target.value)}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 text-sm font-bold mb-2">Cantidad:</label>
                                        <input
                                            type="number"
                                            className="shadow border rounded w-full py-2 px-3"
                                            value={pedido.cantidad_personas}
                                            onChange={(e) => handlePedidoChange(index, 'cantidad_personas', Number(e.target.value))}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 text-sm font-bold mb-2">Total:</label>
                                        <input
                                            type="number"
                                            className="shadow border rounded w-full py-2 px-3"
                                            value={pedido.total}
                                            onChange={(e) => handlePedidoChange(index, 'total', Number(e.target.value))}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 text-sm font-bold mb-2">Anticipo:</label>
                                        <input
                                            type="number"
                                            className="shadow border rounded w-full py-2 px-3"
                                            value={pedido.anticipo}
                                            onChange={(e) => handlePedidoChange(index, 'anticipo', Number(e.target.value))}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 text-sm font-bold mb-2">Restante:</label>
                                        <input
                                            type="number"
                                            className="shadow border rounded w-full py-2 px-3"
                                            value={pedido.restante}
                                            onChange={(e) => handlePedidoChange(index, 'restante', Number(e.target.value))}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 text-sm font-bold mb-2">Hora de Entrega:</label>
                                        <input
                                            type="time"
                                            className="shadow border rounded w-full py-2 px-3"
                                            value={pedido.hora_entrega}
                                            onChange={(e) => handlePedidoChange(index, 'hora_entrega', e.target.value)}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 text-sm font-bold mb-2">Estado:</label>
                                        <select
                                            className="shadow border rounded w-full py-2 px-3"
                                            value={pedido.estado}
                                            onChange={(e) => handlePedidoChange(index, 'estado', e.target.value)}
                                        >
                                            <option value="Por entregar">Por entregar</option>
                                            <option value="Entregado">Entregado</option>
                                        </select>
                                    </div>
                                </div>
                            ))}
                            <button
                                className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-4"
                                onClick={handleActualizar}
                            >
                                Actualizar Detalles
                            </button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="container mx-auto p-4">
                    <h1 className="text-3xl font-bold mb-6">Gestión de Restaurante</h1>
                    
                    <div className="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                        <h2 className="text-2xl font-bold mb-4">Lista de Clientes y Pedidos</h2>
                        <table className="min-w-full">
                            <thead>
                                <tr>
                                    <th className="px-4 py-2">Nombre</th>
                                    <th className="px-4 py-2">Teléfono</th>
                                    <th className="px-4 py-2">Dirección</th>
                                    <th className="px-4 py-2">Menú</th>
                                    <th className="px-4 py-2">Cantidad</th>
                                    <th className="px-4 py-2">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {clientesPedidos.map((cp, index) => (
                                    <tr key={index} className="hover:bg-gray-100">
                                        <td className="border px-4 py-2">
                                            <button
                                                className="text-blue-500 hover:underline"
                                                onClick={() => handleClienteClick(cp.cliente.id)}
                                            >
                                                {cp.cliente.nombre}
                                            </button>
                                        </td>
                                        <td className="border px-4 py-2">{cp.cliente.telefono}</td>
                                        <td className="border px-4 py-2">{cp.cliente.direccion}</td>
                                        <td className="border px-4 py-2">{cp.pedido.menu}</td>
                                        <td className="border px-4 py-2">{cp.pedido.cantidad_personas}</td>
                                        <td className="border px-4 py-2">${cp.pedido.total.toFixed(2)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <ClienteDetalle />

                    <div className="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                        <h2 className="text-2xl font-bold mb-4">Ventas Totales</h2>
                        <p className="text-3xl font-bold">${ventasTotales.toFixed(2)}</p>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
